// Парсим ответ от API
const apiResponse = $input.first().json;
const timings = apiResponse.data.timings;

// ПРАВИЛЬНОЕ время Уфы: UTC+5
const now = new Date();
const ufaTime = new Date(now.getTime() + (5 * 60 * 60 * 1000)); // +5 часов

// Намазы для проверки
const prayers = [
  { name: 'Фаджр', key: 'Fajr' },
  { name: 'Зухр', key: 'Dhuhr' },
  { name: 'Аср', key: 'Asr' },
  { name: 'Магриб', key: 'Maghrib' },
  { name: 'Иша', key: 'Isha' }
];

let result = {
  currentTime: ufaTime.getUTCHours().toString().padStart(2, '0') + ':' + ufaTime.getUTCMinutes().toString().padStart(2, '0'),
  nextPrayer: null,
  nextPrayerTime: null,
  timeLeft: null,
  shouldNotify: false
};

// Ищем следующий намаз
for (const prayer of prayers) {
  const [prayerHours, prayerMinutes] = timings[prayer.key].split(':').map(Number);
  
  // Время намаза уже в UTC+5
  const prayerTime = new Date(ufaTime);
  prayerTime.setUTCHours(prayerHours, prayerMinutes, 0, 0);
  
  // Вычисляем разницу в минутах
  const diffMs = prayerTime - ufaTime;
  const diffMinutes = Math.floor(diffMs / (1000 * 60));
  
  console.log(`Намаз ${prayer.name}: ${timings[prayer.key]}, разница: ${diffMinutes} минут`);
  
  // Отправляем уведомление ТОЛЬКО когда РОВНО 5 минут
  if (diffMinutes === 5) {
    result.nextPrayer = prayer.name;
    result.nextPrayerTime = timings[prayer.key];
    result.timeLeft = diffMinutes;
    result.shouldNotify = true;
    break;
  }
}

// Возвращаем результат ТОЛЬКО если нужно отправить уведомление
if (result.shouldNotify) {
  return [result];
} else {
  return [];
}
